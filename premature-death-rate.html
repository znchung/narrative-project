<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>

<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>

<style>
    circle {
        fill: lightblue;
        stroke: black;
    }
</style>

<body onload='init()'>
    <div id="tooltip"></div>
    <svg id="map">
    </svg>
    <script>
        async function init() {

            var margin = { top: 20, right: 10, bottom: 0, left: 10 },
                width = 1000 - margin.left - margin.right,
                height = 400 - margin.top - margin.bottom;

            var svg = d3.select("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var tooltip = d3.select("#tooltip")
                                .style("opacity", 0)
                                .attr("class", "tooltip")
                                .style("background-color", "white")
                                .style("border", "solid")
                                .style("border-width", "1px")
                                .style("border-radius", "5px")
                                .style("padding", "5px")
                                .style("position", "absolute")

            var projection = d3.geoMercator()
                .scale(70)
                .center([0, 20])
                .translate([width / 2 - margin.left, height / 2]);

            var domain = [0, 20, 40, 60, 80, 100]
            var range = ["#FBE6DB", "#F3BEA5", "#EE9779", "#E77253", "#CC3F32", "#94221E"]
            var colorScale = d3.scaleThreshold()
                .domain(domain)
                .range(range)

            var promises = []
            var data = d3.map();

            promises.push(d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson"))
            promises.push(d3.csv("rate-of-premature-deaths-due-to-alcohol.csv", function (d) { data.set(d.Code, +d.Deaths); }))
            myDataPromises = Promise.all(promises).then(function (topo) {

                let mouseOver = function (d) {
                    d3.selectAll(".topo")
                        .style("opacity", .5)
                        .transition()
                        .duration(200)

                    d3.select(this)
                        //.filter(function(d){d.total = data.get(d.id) || 0; return d.total <= max_pop && d.total >= min_pop})
                        
                        .style("opacity", 1)
                        .style("stroke", "black")
                        .transition()
                        .duration(200)

                    d.total = data.get(d.id) || 0;

                    tooltip
                        .style("opacity", 0.8)
                        .html(d.id + ": " + d3.format(",.2r")(d.total))
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");

                    d3.select("#annotation")
                        .style("opacity", 0)


                }

                let mouseLeave = function (d) {
                    d3.selectAll(".topo")
                        
                        .style("opacity", .7)
                        .transition()
                        .duration(200)

                    d3.selectAll(".topo")
                        
                        .style("stroke", "transparent")
                        .transition()
                        .duration(200)

                    d3.select("#annotation")
                        .style("opacity", 1)

                    d3.select("tooltip")
                        .style("opacity", 0)
                }

                var topo = topo[0]

                // Draw the map
                svg.append("g")
                    .selectAll("path")
                    .style("opacity", .7)
                    .data(topo.features)
                    .enter()
                    .append("path")
                    .attr("class", "topo")
                    // draw each country
                    .attr("d", d3.geoPath()
                        .projection(projection)
                    )
                    // set the color of each country
                    .attr("fill", function (d) {
                        d.total = data.get(d.id) || 0;

                        if (d.total <= 0) {
                            return "#F0F0F0";
                        } else {
                            return colorScale(d.total);
                        }
                    })
                    .on("mouseover", mouseOver)
                    .on("mouseleave", mouseLeave)


                // Features of the annotation
                const annotations = [
                    {
                        note: {
                            label: "despite its great territorial extension Australia has only 20 million inhabitants.",
                            title: "Australia Population",
                            wrap: 150,  // try something smaller to see text split in several lines
                            padding: 10   // More = text lower

                        },
                        color: ["#852170"],
                        x: projection([150.916672, -31.083332])[0],
                        y: projection([150.916672, -31.083332])[1],
                        dy: -30,
                        dx: 10
                    }
                ]



                // Add annotation to the chart
                const makeAnnotations = d3.annotation()
                    .annotations(annotations)

                svg.append("g")
                    .style("opacity", 1)
                    .attr("id", "annotation")
                    .call(makeAnnotations)

            });




            // console.log(data);

        }
    </script>
</body>

</html>